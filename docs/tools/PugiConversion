#!/bin/bash
# Takes in PugiXML and emits XML files appropriate for direct inclusion in the Physgame library
# This expects the PugiXML source files to be in the subdirectory call PugiSrc

# This script isn't magic, it was designed with version 1.0 of PugiXML in mind. If new features have been added, then new commands
# will need to be add to rename those as well.

#error codes - These match the Header prepending tool
E_BADARGS=1
E_MISSINGPUGIXML=3

#Input Files
PugiCppFile="PugiSrc/pugixml.cpp"
PugiHFile="PugiSrc/pugixml.hpp"
PugiConfigFile="PugiSrc/pugiconfig.hpp"
PugiTempHFile="PugiSrc/temp.hpp"

#Output Files
OutDir="../../physgameengine/src"
NewHFileOnly="xml.h"
NewCppFileOnly="xml.cpp"
NewHFile="$OutDir/$NewHFileOnly"
NewCppFile="$OutDir/$NewCppFileOnly"

#Some other variables we will be using
Hardstring="This should not be found on any lineasdfasdfasdfasdf"	# this Should not appear in any of the Files, if it does, change it.
OurLicenseFile="fileheader.txt"
OurCopyright="\n * Software, Files, Libraries and all other items referenced in this clause refers only\n * to the contents of this file and associated documentation.\n *\n"
IncompleteCopyright1=" * Copyright (c) 2006-2010 Arseny Kapoulkine"
CompleteCopyright1="$OurCopyright * Copyright © 2006-2010 Arseny Kapoulkine"
IncompleteCopyright2=" * pugixml parser - version 1.0"
CompleteCopyright2="$OurCopyright * Pugixml parser - version 1.0"

#Make the Files to begin appending Source code to.
cat  $OurLicenseFile > $NewCppFile
cat  $OurLicenseFile > $PugiTempHFile

# This lops of the end copyright because we can use the ending from the other file we are merging with
PugiConfigGrabUntil="#endif"						# The Copyright notices, and other string to search for in the PugiConfig File
				#This next line uses grep to get the line number of the token we are searching for and then sends the results to
				#sed to strip of the : and the token appended to the value we want.
PugiConfigGrabLineCount=`grep "$PugiConfigGrabUntil" $PugiConfigFile -n | head -n1 | sed s/:.*//g`
head -n$PugiConfigGrabLineCount $PugiConfigFile  >> $PugiTempHFile

# This Lops of the first copyright notice by ommision (since this is the last part of the file we will keep the tail copyright) and appends the results to the results of the Config Transformation
PugiHeaderGrabUntil="*/"						# This ends the copyright header in the pugiheader file
PugiHeaderGrabLineCount=`grep "$PugiHeaderGrabUntil" $PugiHFile -n | head -n1 | sed s/:.*//g`
PugiHeaderTotalLineCount=`grep "$Hardstring" $PugiHFile -vc`
PugiHeaderTailLineCount=$[PugiHeaderTotalLineCount-PugiHeaderGrabLineCount]
tail -n$PugiHeaderTailLineCount $PugiHFile | sed -e s/'#include "pugiconfig.hpp"'//g  >> $PugiTempHFile

#This Does a number of transformations on the PugiHeader file before placing the complete converted parts onto the new headerfile
#	- Replaces series of 4 spaces with tabs (seems to be an issue with the original source Files)
#	- Remove reference to old filenames
#	- Appends a notice to Arseny's Copyright that it only covers items arseny wrote.
#	- clean up CopyRight Symbols as (c) is meaningless in some jurisdications (as per RMS)
#	- Put the results in the final place they belong
cat $PugiTempHFile | sed  -e s/'    '/'	'/g -e s/"$IncompleteCopyright1"/"$CompleteCopyright1"/g -e s/"$IncompleteCopyright2"/"$CompleteCopyright2"/g -e s/\([cC]\)/©/g > $NewHFile

# This does mostly the same thing that the header transfortmation does, a bunch of cleanup and putting the code where it belongs
cat $PugiCppFile | sed -e s/'#include "pugixml.hpp"'/"#include \"$NewHFileOnly\""/g -e s/'    '/'	'/g -e s/"$IncompleteCopyright1"/"$CompleteCopyright1"/g -e s/"$IncompleteCopyright2"/"$CompleteCopyright2"/g -e s/\([C]\)/©/g > $NewCppFile



